<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title></title>


    <link href="css/style.css" rel="stylesheet" type="text/css">



  <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="vendor/d3.v3.min.js" charset="utf-8"></script>
  <script type="text/javascript" src="vendor/hexbin.js"></script>
    <script type="text/javascript" src="vendor/lodash.min.js"></script>

<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
  <script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.0-rc.2/angular.js"></script>
  <script type='text/javascript' src="vendor/lodash.min.js"></script>
  <script type='text/javascript' src="src/services-webworker.js"></script>
  <script type="text/javascript" src="src/templates-common.js"></script>
  <script type='text/javascript' src="src/utilities.som.js"></script>
  <script type='text/javascript' src="src/services-som.js"></script>




</head>
<body>
  <div ng-app="mainApp">
  
  <div ng-controller="SOMController">

    <h2>SOM test (N=<span ng-bind="NumRows"></span>)</h2>

    <div id="status" ng-bind="Task"></div>

    <div id="progressbar">
      <span ng-style="{'width': Progress}" ></span>
    </div>

    <div id="planes"></div>
    
     
  </div>
</div>




<script type='text/javascript'>//<![CDATA[

  


  // Module for injecting lodash
  angular.module('ext.lodash', []).factory('_', function lodash() {
      return window._;
  });




  // Main app
  var mainApp = angular.module("mainApp",
      [ 'templates-common', 
        'services.webworker',
        'ext.lodash',
        'services.som']);





  mainApp.controller('SOMController', 
    function($scope, $q, $timeout, WebWorkerService, SOMService) {

  
      var _s; // SOM object
      var dummy_data;
      var data_columns = [];
      var sampleids = [];




      d3.json("data/sampledata.json", function(error, json) {

        if (error) return console.warn(error);


        var training_vars = 
          [ "XXL-VLDL-L","XL-VLDL-L","L-VLDL-L","M-VLDL-L",
            "S-VLDL-L","XS-VLDL-L","IDL-L","L-LDL-L","M-LDL-L",
            "S-LDL-L","XL-HDL-L","L-HDL-L","M-HDL-L","S-HDL-L"];
      
        // Picks the specified values and sample ids from data object 
        // and arranges them in arrays.
        
        

        var res = prepare_data_columns(json.result.values, training_vars);

        sampleids = res.sampleids;
        data_columns = res.data_columns;

        $scope.Task = "Initializing...";
        $scope.NumRows = sampleids.length;
        
        SOMService.create(7,9, sampleids, data_columns).then(

          function(result) {

            _s = result.som;
            
            $scope.Task = "Training...";

            SOMService.train(_s).then(function(res){
            // success
            console.log('trained!');


            make_component_planes();

            }, function(err) {
                console.log('Error '+err);
            // error
            }, function(percentComplete) {
            // notify
            $scope.Progress =  (4*percentComplete) + 'px';

            }); 
          },
          function() {},

          function(percentComplete) {
            // notify
            $scope.Progress =  (4*percentComplete) + 'px';
            
          }

        ); 








        
        

        function make_component_planes() {

            var plane_spec =  [{name: 'Alanine', data: dummy_data.Ala}, 
                                    {name: 'HDL-C', data: dummy_data['HDL-C'] }, 
                                    {name: 'Phenylalanine', data: dummy_data['Phe']},
                                    {name: 'Serum-TG', data: dummy_data['Serum-TG']},
                                    {name: 'Glucose', data: dummy_data['Glc']},
                                    {name: 'LDL-C', data: dummy_data['LDL-C']},
                                    {name: 'Tyrosine', data: dummy_data['Tyr']},
                                    {name: 'Remnant-C', data: dummy_data['Remnant-C']},
                                    ];

            var planes_drawn = 0;


            $scope.Task = "Drawing component plane for " + plane_spec[0].name;

            SOMService.calculate_component_plane( 
              _s, 
              sampleids, 
              plane_spec[0].data, 
              plane_spec[0].name
            ).then( // returns a promise
              draw_plane_and_do_next,  // success
              undefined,  // error
              report_progress //notify
            );


            

            function draw_plane_and_do_next(res) {
                
                $("#spinner-container").hide();

                draw_plane(res.plane, '#planes');

                planes_drawn++;
                
                if(planes_drawn < plane_spec.length) {
                    
                    $scope.Task = "Drawing component plane for " + plane_spec[planes_drawn].name;
                    SOMService.calculate_component_plane( 
                      _s, 
                      sampleids, 
                      plane_spec[planes_drawn].data, 
                      plane_spec[planes_drawn].name
                    ).then( // returns a promise
                      draw_plane_and_do_next,  // success
                      undefined,  // error
                      report_progress //notify
                    );


                } else {
                  $scope.Task = "Done!";
                }

            }


            function report_progress(progress) {
              $scope.Progress =  (4*progress) + 'px';
            }


  
          }
            
      });

    



      function draw_plane(plane, elem) {

        var labelFormat = d3.format('.2f');

        var margin = {
          top: 30,
          right: 30,
          bottom: 30,
          left: 30
        },
        
        
        width = 500;
        height = width * 0.75;

        var rows = plane.size.m;
        var cols = plane.size.n;

        var hexRadius = Math.floor((width / cols)*0.5);
        var points = [];



        for(var k in plane.cells)  {
            var cell = plane.cells[k];
            var datarow = [hexRadius * cell.x * 1.75, hexRadius * cell.y * 1.5, cell.color];
            points.push(datarow);
          }


        

        var hexbin = d3.hexbin()
            .radius(hexRadius);


        var container = d3.select(elem).insert("div", ":first-child");

        container.style('opacity' , 0);

        container.append("p").attr("class","variable").text(plane.variable);

        var svg = container.append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        svg.append("g")
            .selectAll(".hexagon")
            .data(hexbin(points))
            .enter().append("path")
            .attr("class", "hexagon")
            .attr("d", function (d) {
            return "M" + d.x + "," + d.y + hexbin.hexagon();
        })
            .attr("stroke", "#fff")
            .attr("stroke-width", "2px")
            .style("fill", function (d) {
              return d[0][2];
            /*return d3.rgb(255-d[0][2]*255,255-d[0][2]*255,255-d[0][2]*255).toString(); */
        });



        svg.append("g")
              .selectAll(".label")
              .data(plane.labels)
              .enter()
              .append("text")
              .attr("class", "label noselect")
              .attr('text-anchor', 'middle')
              .attr('alignment-baseline', 'middle')
              .attr("x", function(d) { 
                var x = d.x;
                var y = d.y;
                if( (y % 2) === 0 ) { return x*hexRadius*1.75; }
                if( (y % 2) === 1 ) { return hexRadius*0.75 + x*hexRadius*1.75; }
              })
              .attr("y", function(d) { 
                return (d.y) * hexRadius * 1.5;
              })
              .style("fill", function(d) { return d.color; })
              .text( function(d) { return labelFormat( +d.label ); });       

        container.transition().delay(1000).duration(500).style('opacity',1);
      }




      function prepare_data_columns(dataobjectarray, training_vars) {

        var all_variables = [];

        for(var key in dataobjectarray[0].variables) {
          all_variables.push(key);

        }

        var no_missing_data_array = [];
        var missing = false;

        for(var i=0;i<dataobjectarray.length;i++) {

          /*missing = false;

          for(var j=0;j<all_variables.length;j++) {
            if(isNaN(parseFloat(dataobjectarray[i].variables[all_variables[j]])) || 
              dataobjectarray[i].variables[all_variables[j]] == 0
              ) {
              missing = true;
              break;
            } 
            
          }

          if(!missing) { */
            no_missing_data_array.push(dataobjectarray[i]);
          //}
        }

        for(var j=0;j<training_vars.length;j++) { 
            data_columns[j] = [];
        }

        for(var i=0;i<no_missing_data_array.length;i++) {
          
          for(var j=0;j<training_vars.length;j++) {
            data_columns[j][i] = no_missing_data_array[i].variables[training_vars[j]];
          }

          sampleids[i] = { 'dataset' : no_missing_data_array[i].dataset, 'sampleid'  : no_missing_data_array[i].sampleid };
        }

        dummy_data = {};

        for(var key in dataobjectarray[0].variables) {
          dummy_data[key] = new Array(no_missing_data_array.length);
          for(var i=0;i<no_missing_data_array.length;i++) {
            dummy_data[key][i] = no_missing_data_array[i].variables[key];
          }
        }

        return {'sampleids' : sampleids, 'data_columns' : data_columns};

      }




  });



//]]> 

</script>

  
</body>

</html>